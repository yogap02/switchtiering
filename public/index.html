<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Keyboard Switch Tier List</title>
    <script src="env.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            background: #111;
            color: white;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .left-panel {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            /* Allow scrolling for tier list if it gets too long */
            display: flex;
            flex-direction: column;
        }

        .right-panel {
            width: 22%;
            background: #111;
            border-left: 2px solid #333;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            /* Include padding/border in width */
        }

        .right-panel .search {
            padding: 10px;
            border-bottom: 2px solid #333;
        }

        .search input {
            width: calc(100% - 16px);
            /* Adjust width for padding */
            padding: 8px;
            border-radius: 4px;
            border: none;
            font-size: 1em;
            background: #222;
            color: white;
        }

        .scrollable-switches {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            /* Responsive columns */
            gap: 10px;
            justify-content: center;
            align-content: start;
        }

        .tier {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 8px;
        }

        .label {
            width: 40px;
            height: 80px;
            font-weight: bold;
            text-align: center;
            margin-right: 10px;
            border-radius: 4px;
            padding: 5px;
            color: black;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            /* Make S, A, B labels more prominent */
        }

        .label h2 {
            margin: 0;
            /* Remove default margin from h2 */
            font-size: 1em;
            /* Control font size within the label div */
        }

        .slot {
            display: flex;
            flex-wrap: wrap;
            align-items: flex-start;
            /* Align items to the top of the slot */
            min-height: 90px;
            /* Minimum height for empty slots */
            gap: 5px;
            flex-grow: 1;
            padding: 5px;
            border: none;
            border-radius: 4px;
        }

        .item {
            background: #333;
            border: 1px solid #888;
            border-radius: 10px;
            padding: 5px;
            cursor: grab;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.4);
            text-align: center;
            width: 80px;
            height: 80px;
            /* Keep height fixed to control item size */
            flex-shrink: 0;
            /* Prevent items from shrinking in flex containers */
        }

        .item img {
            max-width: 50px;
            max-height: 50px;
            object-fit: contain;
            margin-bottom: 5px;
            border-radius: 2px;
        }

        .item-label {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            padding: 0 2px;
            box-sizing: border-box;
            flex-grow: 1;
            /* Allow label to take available vertical space if content wraps */
        }

        .item-label span {
            word-wrap: break-word;
            white-space: normal;
            line-height: 1.2;
        }

        .item:active {
            cursor: grabbing;
        }

        /* Tier specific colors */
        .S {
            background: #ff6b6b;
        }

        .A {
            background: #ffa94d;
        }

        .B {
            background: #ffd43b;
        }

        .C {
            background: #69db7c;
        }

        .D {
            background: #74c0fc;
        }

        .E {
            background: #9775fa;
        }

        .F {
            background: #f783ff;
        }

        /* Drag over effect */
        .slot.drag-over {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: #eee;
        }

        .dragging-hidden {
            opacity: 0;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 20px;
        }

        .top-bar h3 {
            margin: 0;
        }

        .action-buttons button {
            background-color: #555;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 10px;
            transition: background-color 0.2s ease;
        }

        .action-buttons button:hover {
            background-color: #777;
        }
    </style>
</head>

<body>
    <div class="left-panel">
        <div class="top-bar">
            <h3>Mechanical Keyboard Switch Tier List</h3>
            <div class="action-buttons">
                <button id="resetButton">Reset</button>
                <button id="exportButton">Export as Image</button>
            </div>
        </div>
        <div id="tier-list">
            <div class="tier">
                <div class="label S">
                    <h2>S</h2>
                </div>
                <div class="slot" data-tier="S"></div>
            </div>
            <div class="tier">
                <div class="label A">
                    <h2>A</h2>
                </div>
                <div class="slot" data-tier="A"></div>
            </div>
            <div class="tier">
                <div class="label B">
                    <h2>B</h2>
                </div>
                <div class="slot" data-tier="B"></div>
            </div>
            <div class="tier">
                <div class="label C">
                    <h2>C</h2>
                </div>
                <div class="slot" data-tier="C"></div>
            </div>
            <div class="tier">
                <div class="label D">
                    <h2>D</h2>
                </div>
                <div class="slot" data-tier="D"></div>
            </div>
            <div class="tier">
                <div class="label E">
                    <h2>E</h2>
                </div>
                <div class="slot" data-tier="E"></div>
            </div>
            <div class="tier">
                <div class="label F">
                    <h2>F</h2>
                </div>
                <div class="slot" data-tier="F"></div>
            </div>
        </div>
    </div>

    <div class="right-panel">
        <div class="search">
            <h3>Switches List</h3>
            <input type="text" id="searchInput" placeholder="Search switches...">
        </div>
        <div class="scrollable-switches slot" id="pool">
        </div>
    </div>

    <script>
        const pool = document.getElementById('pool');
        const searchInput = document.getElementById('searchInput');
        const resetButton = document.getElementById('resetButton');
        const exportButton = document.getElementById('exportButton');
        const tierSlots = document.querySelectorAll('#tier-list .slot');

        let allSwitchData = [];
        let currentSwitchData = [];
        let draggedItem = null;

        function renderSwitches(filter = '') {
            pool.innerHTML = '';
            const filteredSwitches = currentSwitchData.filter(s =>
                s.name.toLowerCase().includes(filter.toLowerCase())
            );

            filteredSwitches.forEach(s => {
                const div = document.createElement('div');
                div.className = 'item';
                div.draggable = true;
                div.dataset.switchName = s.name;
                div.innerHTML = `
                    <img src="${s.img}" alt="${s.name}" />
                    <div class="item-label"><span>${s.name}</span></div>
                `;
                pool.appendChild(div);
            });
            initDragAndDrop(); // Re-initialize drag and drop for newly rendered items
        }

        function initDragAndDrop() {
            const draggables = document.querySelectorAll('.item');
            const allDropTargets = document.querySelectorAll('.slot'); // Select all slots, including the pool

            draggables.forEach(item => {
                // Remove existing listeners to prevent duplicates (important after re-rendering)
                item.removeEventListener('dragstart', handleDragStart);
                item.removeEventListener('dragend', handleDragEnd);

                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
            });

            allDropTargets.forEach(slot => {
                // Remove existing listeners
                slot.removeEventListener('dragover', handleDragOver);
                slot.removeEventListener('dragleave', handleDragLeave);
                slot.removeEventListener('drop', handleDrop);

                // Add new listeners
                slot.addEventListener('dragover', handleDragOver);
                slot.addEventListener('dragleave', handleDragLeave);
                slot.addEventListener('drop', handleDrop);
            });
        }

        function handleDragStart(e) {
            draggedItem = this; // 'this' refers to the item being dragged
            e.dataTransfer.setData('text/plain', this.dataset.switchName || this.querySelector('.item-label span').textContent);
            e.dataTransfer.effectAllowed = 'move';
            setTimeout(() => this.classList.add('dragging-hidden'), 0);
        }

        function handleDragEnd() {
            if (draggedItem) {
                draggedItem.classList.remove('dragging-hidden');
                draggedItem = null;
            }
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            this.classList.add('drag-over');
        }

        function handleDragLeave() {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');

            if (draggedItem) {
                // If dropping into the pool, ensure it's re-initialized for dragging
                if (this.id === 'pool') {
                    this.appendChild(draggedItem);
                    // No need to re-initDrag() here, as the item itself retains its draggable property
                    // and its listeners are still active. The renderSwitches function
                    // will re-attach all listeners when it's called (e.g. on search or reset).
                } else {
                    this.appendChild(draggedItem);
                }
            }
        }

        // --- Action Buttons ---
        resetButton.addEventListener('click', () => {
            // Clear all tier slots
            tierSlots.forEach(slot => {
                while (slot.firstChild) {
                    pool.appendChild(slot.firstChild); // Move items back to pool
                }
            });
            // Re-render all switches in the pool (effectively resetting their order too)
            renderSwitches();
            searchInput.value = ''; // Clear search input
        });

        exportButton.addEventListener('click', () => {
            const tierListElement = document.getElementById('tier-list');
            // Temporarily hide scrollbars for cleaner screenshot if any
            const originalOverflow = document.body.style.overflow;
            document.body.style.overflow = 'hidden';

            html2canvas(tierListElement, {
                scale: 2, // Increase scale for better quality image
                logging: false, // Disable console logs from html2canvas
                useCORS: true // Important for images loaded from different origins
            }).then(canvas => {
                // Restore original overflow
                document.body.style.overflow = originalOverflow;

                const link = document.createElement('a');
                link.download = 'keyboard-switch-tier-list.png';
                link.href = canvas.toDataURL('image/png');
                link.click(); // Programmatically click the link to trigger download
            }).catch(error => {
                document.body.style.overflow = originalOverflow; // Ensure overflow is reset even on error
                console.error('Error exporting tier list:', error);
                alert('Could not export image. Please check the console for details.');
            });
        });

        // --- Initial Load ---
        searchInput.addEventListener('input', (e) => {
            renderSwitches(e.target.value);
        });
        const firebaseConfig = {
            apiKey: window.ENV?.FIREBASE_API_KEY,
            authDomain: window.ENV?.FIREBASE_AUTH_DOMAIN,
            projectId: window.ENV?.FIREBASE_PROJECT_ID,
            appId: window.ENV?.FIREBASE_APP_ID,
            databaseURL: window.ENV?.FIREBASE_DATABASE_URL
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        database.ref('/switches').once('value')
            .then((snapshot) => {
                let switches = []
                const data = snapshot.val()
                for (a in data) {
                    console.log('data a:', data[a]);
                    switches.push(data[a]);
                }
                currentSwitchData = [...switches];
                renderSwitches();
            })
            .catch((err) => {
                console.error('Realtime Database fetch failed:', err);
            });
    </script>
</body>

</html>